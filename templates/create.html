{% extends 'base.html' %}
{% block content %}

<h2>Tạo bài viết mới</h2>

<form method="POST" enctype="multipart/form-data" onsubmit="saveContent()">
    <div class="mb-2">
        <input type="text" name="title" class="form-control" placeholder="Tiêu đề" required>
    </div>

    <div class="mb-2">
        <label>Chọn ảnh:</label>
        <input type="file" name="image" class="form-control">
    </div>

    <div class="mb-2">
        <label>Chọn danh mục:</label>
        <select name="category_id" class="form-select">
            {% for cat in categories %}
            <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="editor" style="height:300px;"></div>
    <input type="hidden" name="content" id="content">

    <div class="mt-3 mb-2">
        <h5>Dự đoán ML</h5>
        <input type="number" id="f1" placeholder="Feature 1">
        <input type="number" id="f2" placeholder="Feature 2">
        <input type="number" id="f3" placeholder="Feature 3">
        <button type="button" class="btn btn-info btn-sm" onclick="predictAndInsert()">Chèn dự đoán</button>
    </div>

    <button type="submit" class="btn btn-primary mt-2">Lưu bài viết</button>
</form>

<script>
var quill = new Quill('#editor', { theme: 'snow' });

function saveContent() {
    document.getElementById('content').value = quill.root.innerHTML;
}

function predictAndInsert() {
    let f1 = parseFloat(document.getElementById('f1').value) || 0;
    let f2 = parseFloat(document.getElementById('f2').value) || 0;
    let f3 = parseFloat(document.getElementById('f3').value) || 0;

    fetch('/predict', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({feature1:f1, feature2:f2, feature3:f3})
    })
    .then(r=>r.json())
    .then(d=>{
        if(d.result !== undefined){
            let html = `<p><strong>Dự đoán ML:</strong> ${d.result}</p>`;
            quill.clipboard.dangerouslyPasteHTML(quill.getLength(), html);
        } else {
            alert('Lỗi: '+ (d.error || 'Không nhận kết quả'));
        }
    });
}
</script>

{% endblock %}
